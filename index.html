<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmos Daily ‚ú® Explore the Universe</title>
  
  <!-- Basic description meta tag -->
  <meta name="description" content="Explore your curiosity | In awe and wonder of the Universe üå†">
  
  <!-- Open Graph Meta Tags for Link Preview -->
  <meta property="og:title" content="Cosmos Daily | Earth | Solar System | Universe üå†" />
  <meta property="og:description" content="Explore your curiosity | In awe and wonder of the Universe üå†" />
  <meta property="og:image" content="https://cosmos.kluxy.app/images/preview.png" />
  <meta property="og:image:secure_url" content="https://cosmos.kluxy.app/images/preview.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Cosmos Daily - Explore the wonders of the universe" />
  <meta property="og:url" content="https://cosmos.kluxy.app/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Cosmos Daily" />
  <meta property="og:locale" content="en_US" />
  
  <!-- Twitter Card Tags (WhatsApp sometimes uses these) -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cosmos Daily | Earth | Solar System | Universe üå†" />
  <meta name="twitter:description" content="Explore your curiosity | In awe and wonder of the Universe üå†" />
  <meta name="twitter:image" content="https://cosmos.kluxy.app/images/preview.png" />
  
  <!-- Force WhatsApp to re-scrape the page (remove after testing) -->
  <!-- <meta http-equiv="refresh" content="0; url=https://cosmos.kluxy.app/?v=2" /> -->
  
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&family=Syne:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå†</text></svg>">
  <style>
    :root {
      --neon-purple: hsl(270, 100%, 70%);
      --hologram-blue: hsl(210, 100%, 60%);
      --cyber-gradient: linear-gradient(135deg, var(--neon-purple), var(--hologram-blue));
      --deep-space: hsl(240, 30%, 8%);
      --stardust: rgba(255, 255, 255, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--deep-space);
      color: white;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 2rem;
      overflow-x: hidden;
    }
    .galaxy-bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      background:
        radial-gradient(circle at 20% 80%, var(--neon-purple) 0%, transparent 30%),
        radial-gradient(circle at 80% 20%, var(--hologram-blue) 0%, transparent 30%);
      z-index: -1;
      opacity: 0.3;
    }
    .container {
      width: 100%;
      max-width: 800px;
      background: rgba(16, 18, 27, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 3rem;
      border: 1px solid var(--stardust);
      box-shadow: 0 0 50px rgba(140, 82, 255, 0.2);
      transform: perspective(1000px) rotateX(3deg);
      position: relative;
      overflow: hidden;
    }
    .container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        transparent 20%,
        var(--neon-purple),
        transparent 80%
      );
      animation: rotate 20s linear infinite;
      opacity: 0.1;
    }
    @keyframes rotate {
      100% { transform: rotate(360deg); }
    }
    h1 {
      font-family: 'Syne', sans-serif;
      font-size: 3.5rem;
      text-align: center;
      margin-bottom: 2rem;
      background: linear-gradient(45deg, #fff 30%, var(--hologram-blue));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.03em;
      position: relative;
    }
    .generate-btn {
      width: 100%;
      padding: 1.5rem;
      background: var(--cyber-gradient);
      border: none;
      border-radius: 16px;
      color: white;
      font-family: 'Syne', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 25px rgba(140, 82, 255, 0.4);
    }
    .generate-btn::after {
      content: '‚ú¶‚ú¶‚ú¶';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: -100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .generate-btn:hover::after { left: 100%; }
    .section {
      padding: 2rem;
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border-left: 4px solid var(--neon-purple);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
      cursor: pointer;
    }
    .section.visible {
      opacity: 1;
      transform: translateY(0);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.6s ease, box-shadow 0.4s ease;
    }
    .section.visible:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 15px 30px rgba(140, 82, 255, 0.2), 0 5px 15px rgba(66, 153, 225, 0.15);
      border-left: 4px solid var(--hologram-blue);
    }
    .section h2 {
      font-family: 'Syne', sans-serif;
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--hologram-blue);
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .section h2::before {
      content: '';
      width: 12px;
      height: 12px;
      background: var(--cyber-gradient);
      border-radius: 3px;
      transform: rotate(45deg);
    }
    .section p {
      line-height: 1.7;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.9);
    }
    .section p a {
      color: inherit;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .section p a:hover { color: var(--hologram-blue); }
    @media (max-width: 768px) {
      .container { padding: 2rem; border-radius: 20px; }
      h1 { font-size: 2.5rem; }
      .section { padding: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="galaxy-bg"></div>
  <div class="container">
    <h1>COSMOS DAILY</h1>
    <div class="section"><h2>üåç TERRESTRIAL PLACE OF THE DAY</h2><p id="place">Scanning terrestrial coordinates...</p></div>
    <div class="section"><h2>ü™ê SOLAR SYSTEM FACT OF THE DAY</h2><p id="solar">Accessing planetary database...</p></div>
    <div class="section"><h2>‚≠ê MILKY WAY OBJECT OF THE DAY</h2><p id="milkyway">Mapping stellar cartography...</p></div>
    <div class="section"><h2>üåå GALAXY OF THE DAY</h2><p id="galaxy">Computing intergalactic index...</p></div>
    <button class="generate-btn" onclick="generatePost()">EXPLORE üîÑ</button>
  </div>
  <script>
    let isGenerating = false;
    let cosmicData = null;
    const LOCAL_STORAGE_VERSION = '1.0'; // Version tracking for localStorage

    // Initialize on page load
    window.addEventListener('load', initialize);

    // Helper function to generate SHA-256 hash from text
    async function sha256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Helper function to get seen items from localStorage
    function getSeen(category) {
      // Check version - reset if version changed
      const storedVersion = localStorage.getItem('cosmos_version');
      if (storedVersion !== LOCAL_STORAGE_VERSION) {
        console.log(`Version changed from ${storedVersion || 'none'} to ${LOCAL_STORAGE_VERSION}. Resetting tracking.`);
        localStorage.setItem('cosmos_version', LOCAL_STORAGE_VERSION);
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('seen_')) {
            localStorage.removeItem(key);
          }
        });
      }
      
      const seen = JSON.parse(localStorage.getItem(`seen_${category}`) || '[]');
      return new Set(seen);
    }

    // Helper function to save seen items to localStorage
    function saveSeen(category, seenSet) {
      localStorage.setItem(`seen_${category}`, JSON.stringify([...seenSet]));
    }

    // Helper function to get random unseen item
    async function getRandomUnseen(category, data) {
      const seen = getSeen(category);
      
      // Generate hashes for all items if we need to compare
      const hashedItems = await Promise.all(data.map(async (item) => {
        return {
          item: item,
          hash: await sha256(item.text)
        };
      }));
      
      // Filter to find unseen items
      const pool = hashedItems.filter(({ hash }) => !seen.has(hash));
      
      console.log(`${category}: ${pool.length}/${data.length} items available in pool`);
      
      // If all items have been seen or we have an invalid storage state, reset
      if (pool.length === 0 || seen.size >= data.length) {
        console.log(`All ${data.length} items in ${category} have been seen. Resetting tracking.`);
        localStorage.removeItem(`seen_${category}`);
        return getRandomUnseen(category, data); // Retry after reset
      }
      
      const index = Math.floor(Math.random() * pool.length);
      const selected = pool[index];
      
      // Track by hash instead of array index
      seen.add(selected.hash);
      saveSeen(category, seen);
      
      return selected.item;
    }

    // Backup all seen items to JSON
    function backupSeenItems() {
      const backup = {
        version: LOCAL_STORAGE_VERSION,
        timestamp: new Date().toISOString(),
        data: {}
      };
      
      // Collect all seen_ keys
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('seen_')) {
          backup.data[key] = JSON.parse(localStorage.getItem(key));
        }
      });
      
      return JSON.stringify(backup);
    }

    // Restore seen items from backup JSON
    function restoreSeenItems(backupJson) {
      try {
        const backup = JSON.parse(backupJson);
        
        // Check version compatibility
        if (backup.version !== LOCAL_STORAGE_VERSION) {
          console.warn(`Backup version (${backup.version}) differs from current (${LOCAL_STORAGE_VERSION})`);
        }
        
        // Restore all data
        Object.keys(backup.data).forEach(key => {
          localStorage.setItem(key, JSON.stringify(backup.data[key]));
        });
        
        console.log(`Restored backup from ${backup.timestamp}`);
        return true;
      } catch (error) {
        console.error('Failed to restore backup:', error);
        return false;
      }
    }

    async function initialize() {
      try {
        console.log('Initializing Cosmos Daily...');
        
        // Ensure version is set
        if (!localStorage.getItem('cosmos_version')) {
          localStorage.setItem('cosmos_version', LOCAL_STORAGE_VERSION);
        }
        
        // Fetch the cosmic data from the local directory (same as index.html)
        console.log('Fetching cosmic data...');
        const response = await fetch('cosmic_data_full.json');
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        cosmicData = await response.json();
        console.log('Data loaded successfully:', {
          terrestrial: cosmicData.terrestrial.length,
          solar: cosmicData.solar.length,
          milkyway: cosmicData.milkyway.length,
          galaxies: cosmicData.galaxies.length
        });
        
        // Generate initial cosmic wisdom
        generatePost();
        
      } catch (error) {
        console.error('Failed to initialize:', error);
        
        // Fallback data if fetch fails
        console.warn('Using fallback data');
        cosmicData = {
          terrestrial: [{text: "The Salar de Uyuni in Bolivia becomes a giant mirror when wet.", query: "Salar de Uyuni mirror effect"}],
          solar: [{text: "Jupiter's Great Red Spot is a storm bigger than Earth.", query: "Jupiter Great Red Spot"}],
          milkyway: [{text: "The Cannonball Pulsar is racing at 1,130 km/s with a 13-light-year tail.", query: "Cannonball Pulsar"}],
          galaxies: [{text: "Messier 87 hosts the first directly imaged black hole.", query: "Messier 87 black hole image"}]
        };
        
        // Show error in UI
        document.getElementById('place').textContent = `‚ö†Ô∏è Error loading data: ${error.message}`;
        
        // Enable generation with fallback data
        generatePost();
      }
    }

    async function generatePost() {
      if (isGenerating || !cosmicData) {
        console.warn('Cannot generate post: ' + (isGenerating ? 'Already generating' : 'No data available'));
        return;
      }
      
      isGenerating = true;
      
      const btn = document.querySelector('.generate-btn');
      const sections = document.querySelectorAll('.section');
      
      // Reset animation
      sections.forEach(section => section.classList.remove('visible'));
      btn.innerHTML = 'üåÄ CALCULATING COSMOS...';
      btn.disabled = true;

      try {
        // Get random items from each category, tracking what's been seen
        const terrestrialItem = await getRandomUnseen('terrestrial', cosmicData.terrestrial);
        const solarItem = await getRandomUnseen('solar', cosmicData.solar);
        const milkywayItem = await getRandomUnseen('milkyway', cosmicData.milkyway);
        const galaxyItem = await getRandomUnseen('galaxies', cosmicData.galaxies);

        // Animate sections and update content
        sections.forEach((section, index) => {
          setTimeout(() => {
            section.classList.add('visible');
          }, index * 200);
        });
        
        // Update content with links
        updateSectionWithLink('place', terrestrialItem);
        updateSectionWithLink('solar', solarItem);
        updateSectionWithLink('milkyway', milkywayItem);
        updateSectionWithLink('galaxy', galaxyItem);

        // Log current tracking stats to console
        logTrackingStats();

      } catch (error) {
        console.error('Generation error:', error);
        document.getElementById('place').textContent = '‚ö†Ô∏è Error generating content - Try again!';
        sections.forEach(section => section.classList.add('visible'));
      } finally {
        btn.innerHTML = 'EXPLORE üîÑ';
        btn.disabled = false;
        isGenerating = false;
      }
    }

    // Helper function to log tracking statistics
    function logTrackingStats() {
      const stats = {};
      ['terrestrial', 'solar', 'milkyway', 'galaxies'].forEach(category => {
        const seen = getSeen(category);
        const total = cosmicData[category].length;
        stats[category] = {
          seen: seen.size,
          total: total,
          remaining: total - seen.size
        };
      });
      console.table(stats);
    }

    // Helper function to update section with clickable link
    function updateSectionWithLink(elementId, item) {
      const element = document.getElementById(elementId);
      if (!item || !item.text || !item.query) {
        element.textContent = 'Data unavailable';
        return;
      }
      
      // Create the text content first
      element.textContent = item.text;
      
      // Find the parent section element
      const sectionElement = element.closest('.section');
      
      // Make the entire section clickable
      sectionElement.onclick = function() {
        window.open(`https://www.google.com/search?q=${encodeURIComponent(item.query)}`, '_blank');
      };
      
      // Add style to indicate clickability
      sectionElement.style.cursor = 'pointer';
      sectionElement.title = `Click to search: ${item.query}`;
    }
  </script>
</body>
</html>
